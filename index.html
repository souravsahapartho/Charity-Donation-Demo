<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="UniDonate: A Unified, real-time charity donation and management system for financial, food, and goods contributions in Bangladesh.">
    <title>UniDonate - Unified Charity Donation System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }

        /* Standardized Button Animation */
        .dynamic-btn {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .dynamic-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        /* Header Animation */
        .pulsing-heart {
            animation: pulse 1.5s infinite ease-in-out;
            color: #ef4444; /* Red-500 */
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }

        /* Loader Animation */
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #06B6D4; /* Cyan-500 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Pop-In Animation */
        @keyframes modal-pop {
            0% { opacity: 0; transform: scale(0.8) translateY(-20px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .modal-content {
            animation: modal-pop 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        /* Quote Transition */
        .quote-slide {
            transition: opacity 0.5s ease-in-out;
        }

        /* Charity Card Hover Effect */
        .charity-card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .charity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 25px -5px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Matching Highlight */
        .match-highlight {
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.8); /* Strong Cyan glow */
            border-color: #06B6D4;
        }

        /* Hide the default radio/checkbox */
        .tab-radio {
            display: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-hand-holding-heart text-2xl text-teal-600"></i>
                <h1 class="text-2xl sm:text-3xl font-extrabold text-gray-800">UniDonate Platform</h1>
                <div class="text-2xl hidden md:block">
                    <i class="fas fa-heart pulsing-heart"></i>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <!-- Donor Notifications (Visible only in Donor View) -->
                <button id="notification-button" class="relative text-gray-600 hover:text-teal-600 transition-colors hidden" onclick="window.toggleNotifications()">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notification-count" class="absolute top-0 right-0 transform translate-x-1/2 -translate-y-1/2 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center opacity-0 transition-opacity">0</span>
                </button>
                
                <!-- Role Toggle Button -->
                <button id="role-toggle-btn" class="dynamic-btn bg-teal-600 text-white text-sm font-semibold px-4 py-2 rounded-lg shadow-lg hover:bg-teal-700 transition-colors" onclick="window.toggleRole()">
                    Switch to Staff/Admin Login
                </button>
            </div>
        </div>
        <!-- Notification Panel -->
        <div id="notification-panel" class="absolute right-4 mt-2 w-72 bg-white rounded-lg shadow-xl z-50 border border-gray-200 hidden">
            <div class="p-3 border-b font-semibold text-gray-700">Recent Confirmed Donations</div>
            <div id="notification-list" class="max-h-64 overflow-y-auto divide-y divide-gray-100">
                <!-- Notifications load here -->
                <p class="p-3 text-gray-500 text-sm italic text-center">No new confirmed donations.</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 w-full">

        <!-- Role Display Banner -->
        <div id="role-banner" class="mb-6 p-4 rounded-lg text-center font-bold text-lg shadow-md transition-colors">
            <!-- Content updated by JavaScript -->
        </div>

        <!-- LOADER SCREEN -->
        <div id="app-loader" class="fixed inset-0 bg-white z-[101] flex flex-col items-center justify-center transition-opacity duration-500">
            <div class="loader"></div>
            <p class="mt-4 text-xl font-semibold text-gray-700">Connecting to UniDonate System...</p>
        </div>

        <!-- APPLICATION VIEWS (Hidden until loaded) -->
        <div id="app-content" class="hidden">

            <!-- Donor View -->
            <div id="donor-view">
                <div class="grid lg:grid-cols-3 gap-8 mb-8">
                    <!-- Column 1: Quotes -->
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg border-t-4 border-teal-500 flex flex-col justify-center">
                        <h2 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                            <i class="fas fa-hands-helping text-teal-500 mr-2"></i>
                            Inspiring Humanity
                        </h2>
                        <div id="quote-section" class="text-center h-20 flex items-center justify-center">
                            <!-- Quote loads here -->
                            <p class="text-lg italic text-gray-600 quote-slide">Loading motivation...</p>
                        </div>
                    </div>

                    <!-- Column 2 & 3: Donation Input Form & Charity Needs -->
                    <div class="lg:col-span-2">
                        <!-- Donation Form -->
                        <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">Submit Your Contribution</h2>
                            
                            <form id="donation-form" onsubmit="window.handleDonationSubmit(event)">
                                <div class="flex space-x-2 border-b mb-6">
                                    <button type="button" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg transition-colors" data-type="financial" onclick="window.selectDonationType('financial')">Financial</button>
                                    <button type="button" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg transition-colors" data-type="food" onclick="window.selectDonationType('food')">Food Items</button>
                                    <button type="button" class="tab-button px-4 py-2 text-sm font-medium rounded-t-lg transition-colors" data-type="goods" onclick="window.selectDonationType('goods')">Clothing/Supplies</button>
                                </div>

                                <!-- Financial Donation Tab -->
                                <div id="financial-tab" class="donation-tab space-y-4 hidden">
                                    <input type="hidden" name="donationType" value="financial">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Donation Amount (BDT)</label>
                                        <input type="number" name="amount" id="financial-amount" placeholder="e.g., 500 BDT" min="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-shadow" required>
                                    </div>
                                </div>

                                <!-- Food Donation Tab -->
                                <div id="food-tab" class="donation-tab space-y-4 hidden">
                                    <input type="hidden" name="donationType" value="food">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Food Item Details</label>
                                        <textarea name="items" id="food-items" rows="3" placeholder="e.g., 50 kg Rice, 10 kg Lentils, Fresh vegetables" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-shadow" required disabled></textarea>
                                    </div>
                                </div>

                                <!-- Goods Donation Tab -->
                                <div id="goods-tab" class="donation-tab space-y-4 hidden">
                                    <input type="hidden" name="donationType" value="goods">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Goods/Supplies Details</label>
                                        <textarea name="items" id="goods-items" rows="3" placeholder="e.g., 20 Winter blankets (New), 5 boxes of children's books" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-shadow" required disabled></textarea>
                                    </div>
                                </div>
                                
                                <button type="submit" class="dynamic-btn w-full mt-6 bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 transition-colors">
                                    Confirm & Log Donation
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Charity Needs Section -->
                <div class="mt-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-map-marker-alt text-red-500 mr-3"></i>
                        Charity Partners & Urgent Needs (Real-Time)
                    </h2>
                    <div id="charity-needs-list" class="grid sm:grid-cols-2 md:grid-cols-3 gap-6">
                        <!-- Charity cards load here -->
                        <p class="text-gray-600 col-span-full">Waiting for real-time charity needs data...</p>
                    </div>
                </div>

                <!-- Donation Tracking & Audit -->
                <div class="mt-12">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-receipt text-blue-500 mr-3"></i>
                        My Donation Tracking & Audit
                    </h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details / Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="my-donations-table" class="bg-white divide-y divide-gray-200">
                                <!-- My donations load here -->
                                <tr>
                                    <td colspan="4" class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No donations tracked yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Staff/Admin Login View -->
            <div id="login-view" class="hidden max-w-md mx-auto bg-white p-8 rounded-xl shadow-2xl border-t-4 border-red-600">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Staff / Admin Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-id" class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                        <input type="text" id="login-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition-shadow" placeholder="e.g., admin or bd_relief" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 transition-shadow" placeholder="password" required>
                    </div>
                    <button type="submit" class="dynamic-btn w-full bg-red-600 text-white font-semibold py-3 rounded-lg hover:bg-red-700 transition-colors">
                        Log In
                    </button>
                    <p class="mt-4 text-sm text-gray-500 text-center">Admin ID: `admin`, Pass: `uniadmin`</p>
                    <p class="text-sm text-gray-500 text-center">Charity IDs: `bd_relief`, `child_hope` etc., Pass: e.g., `bdrelief123`</p>
                </form>
            </div>

            <!-- Admin Portal View -->
            <div id="admin-view" class="hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-red-600">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center border-b pb-3">
                        <i class="fas fa-user-shield text-red-600 mr-2"></i>
                        Admin Portal: Pending Donations
                    </h2>
                    
                    <!-- Admin Action Confirmation Message -->
                    <div id="admin-action-message" class="mb-4 hidden p-3 rounded-lg border text-sm transition-opacity"></div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details / Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Charity ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                </tr>
                            </thead>
                            <tbody id="pending-donations-table" class="bg-white divide-y divide-gray-200">
                                <!-- Pending donations load here -->
                                <tr>
                                    <td colspan="5" class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No pending donations to review.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Audit History -->
                <div class="mt-8 bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center border-b pb-3">
                        <i class="fas fa-history text-blue-600 mr-2"></i>
                        Audit History (Confirmed Donations)
                    </h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Confirmed</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details / Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Charity ID</th>
                                </tr>
                            </thead>
                            <tbody id="audit-history-table" class="bg-white divide-y divide-gray-200">
                                <!-- Audit history loads here -->
                                <tr>
                                    <td colspan="4" class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No history recorded yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Charity Partner Portal View -->
            <div id="charity-portal-view" class="hidden max-w-xl mx-auto bg-white p-8 rounded-xl shadow-2xl border-t-4 border-teal-600">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center flex items-center justify-center">
                    <i class="fas fa-hand-holding-usd text-teal-600 mr-3"></i>
                    Charity Partner Portal
                </h2>
                <div id="charity-info" class="text-center mb-6">
                    <!-- Charity name and ID load here -->
                </div>
                <form id="update-needs-form">
                    <div class="mb-4">
                        <label for="needs-update" class="block text-sm font-medium text-gray-700 mb-1">Update Urgent Needs List</label>
                        <textarea id="needs-update" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition-shadow" placeholder="Enter a comma-separated list of your current urgent needs (e.g., Winter coats, $5000 for flood relief, Rice bags)"></textarea>
                    </div>
                    <button type="submit" class="dynamic-btn w-full bg-teal-600 text-white font-semibold py-3 rounded-lg hover:bg-teal-700 transition-colors">
                        Publish Needs Update
                    </button>
                    <p class="mt-4 text-xs text-gray-500 text-center">Updates are reflected instantly on the Donor Dashboard.</p>
                </form>
            </div>
        </div>
    </main>

    <!-- Modal Popup for Notifications/Confirmations -->
    <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100] hidden transition-opacity" onclick="window.hideModal()">
        <div id="modal-container" class="bg-white rounded-xl shadow-2xl overflow-hidden w-full max-w-sm modal-content transition-transform" onclick="event.stopPropagation()">
            <div id="modal-header" class="p-4 flex items-center justify-between text-white">
                <h3 id="modal-title" class="text-lg font-semibold flex items-center space-x-2"></h3>
                <button onclick="window.hideModal()" class="text-white hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <p id="modal-message" class="text-gray-700"></p>
                <button onclick="window.hideModal()" class="dynamic-btn mt-6 w-full py-2 rounded-lg text-white font-semibold transition-colors" id="modal-close-button"></button>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer class="bg-gray-100 py-4 mt-8 shadow-inner">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-600">
            <p>&copy; 2024 UniDonate Platform. All Rights Reserved.</p>
            <p class="mt-1 font-semibold text-gray-700">Created by Lionel Messi, CSE Undergrad, UIU</p>
        </div>
    </footer>

    <!-- JavaScript and Firebase Module -->
    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, serverTimestamp, updateDoc, getDocs, where, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are replaced with safe, static defaults 
        // to ensure the app runs on GitHub/Netlify without API key errors.
        const APP_ID = 'uni-donate-github-prod'; 
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSy_MOCK_API_KEY_FOR_GITHUB_TESTING", // THIS IS THE MOCK KEY
            authDomain: "mock-auth-domain.firebaseapp.com",
            projectId: "mock-project-id",
            storageBucket: "mock-storage-bucket.appspot.com",
            messagingSenderId: "1234567890",
            appId: "1:234567890:web:mockappidf12345"
        }; 
        const INITIAL_AUTH_TOKEN = null; 

        // Set logging for debugging purposes
        setLogLevel('debug'); 

        let db, auth;
        let currentUserId = null;
        let userRole = 'donor'; // 'donor', 'charity', 'admin'

        // Global data stores (used by matching logic)
        window.charityNeeds = [];
        window.lastNotificationCount = 0;

        // Quotes for motivation
        const motivationQuotes = [
            "Your small help can make a big difference.",
            "Give a little. Change a life.",
            "Together, we can build hope.",
            "A helping hand is the most powerful gift.",
            "Your kindness today becomes someone’s tomorrow.",
            "Be the reason someone smiles today.",
            "Every donation counts. Every heart matters.",
            "Compassion is the world’s strongest currency.",
            "Hope grows when we share what we have.",
            "You can’t help everyone, but everyone can help someone."
        ];

        // Mock Charity Data for initial setup
        const MOCK_CHARITIES = [
            { id: 'bd_relief', name: 'Bangladesh Flood Relief', totalGained: 150000, region: 'Sylhet', needs: 'Winter blankets, $10000 for housing, Medicine', password: 'bdrelief123' },
            { id: 'child_hope', name: 'Children’s Hope Center', totalGained: 85000, region: 'Dhaka', needs: 'Children\'s books, New toys, School supplies', password: 'childhope123' },
            { id: 'food_bank', name: 'Dhaka Community Food Bank', totalGained: 120000, region: 'Dhaka', needs: 'Rice bags, Lentils, Fresh produce', password: 'foodbank123' },
            { id: 'elder_care', name: 'Elderly Support Foundation', totalGained: 60000, region: 'Chittagong', needs: 'Adult diapers, Walking sticks, Caretaker wages', password: 'eldercare123' },
        ];

        // --- Firebase Initialization and Auth ---

        /**
         * Initializes Firebase app or bypasses to mock data if API key is invalid.
         */
        const initializeFirebase = async () => {
            const loader = document.getElementById('app-loader');

            // CRITICAL FIX: Bypass Firebase API key error when using mock key
            if (FIREBASE_CONFIG.apiKey.includes('MOCK_API_KEY')) {
                console.warn("Detected mock API key. Bypassing Firebase initialization and using local mock data.");
                await setupMockData(); 
                loader.classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                window.renderCharityNeeds(window.charityNeeds);
                window.selectDonationType('financial');
                window.updateRoleView('donor');
                return;
            }

            try {
                const app = initializeApp(FIREBASE_CONFIG);
                db = getFirestore(app);
                auth = getAuth(app);

                // Attempt sign-in
                if (INITIAL_AUTH_TOKEN) {
                    await signInWithCustomToken(auth, INITIAL_AUTH_TOKEN);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        console.log("Auth success. Current User ID:", currentUserId);
                        startRealTimeListeners();
                    } else {
                        console.log("User signed out or anonymous.");
                        currentUserId = null;
                    }
                    loader.classList.add('hidden');
                    document.getElementById('app-content').classList.remove('hidden');
                    window.selectDonationType('financial');
                    window.updateRoleView(userRole); // Initial render
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                // Fallback to mock data if real-time connection fails unexpectedly (e.g., wrong config in production)
                if (!window.charityNeeds || window.charityNeeds.length === 0) {
                     await setupMockData();
                }
                loader.classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                showModal('error', 'Database Error', 'Could not connect to the database. Running in local mock mode.');
            }
        };

        // --- Mock Data Setup (Used when Firebase fails/bypassed) ---

        const setupMockData = async () => {
            console.warn("Using MOCK charity data and NO real-time services. Authentication and transactions will not be persistent.");
            
            // Populate mock data stores
            window.charityNeeds = MOCK_CHARITIES.map(c => ({...c, totalGained: c.totalGained || 0}));
            window.donorDonations = []; 
            window.pendingDonations = []; 
            window.auditHistory = []; 
            
            // Mock Confirmation Function
            window.handleConfirmDonation = (id, type, amount, charityId) => {
                const pendingIndex = window.pendingDonations.findIndex(d => d.id === id);
                if (pendingIndex > -1) {
                    const donation = window.pendingDonations.splice(pendingIndex, 1)[0];
                    // Update donor's local history
                    const donorDonation = window.donorDonations.find(d => d.id === id);
                    if (donorDonation) donorDonation.status = 'Confirmed';

                    window.auditHistory.push(donation);
                    
                    if (type === 'financial') {
                        const charity = window.charityNeeds.find(c => c.id === charityId);
                        if (charity) {
                            charity.totalGained += amount;
                        }
                    }
                    window.showModal('success', 'Confirmation Success', `Mock Donation ID ${id} confirmed and logged!`);
                    window.renderPendingDonations(window.pendingDonations);
                    window.renderAuditHistory(window.auditHistory);
                    window.renderCharityNeeds(window.charityNeeds);
                    window.renderMyDonations(window.donorDonations);
                }
            };

            // Mock Submission function
            window.handleDonationSubmit = (event) => {
                event.preventDefault();
                const form = event.target;
                const formData = new FormData(form);
                const type = formData.get('donationType');
                const targetCharityId = document.querySelector('.charity-card.match-highlight')?.id || 'bd_relief';
                
                let data = {};
                let amount = 0;

                if (type === 'financial') {
                    amount = parseFloat(formData.get('amount'));
                    data = { amount: amount };
                } else if (type === 'food' || type === 'goods') {
                    data = { items: formData.get('items').trim() };
                }

                const newId = crypto.randomUUID();
                const newDonation = {
                    id: newId,
                    donorId: 'mock-donor',
                    charityId: targetCharityId,
                    type: type,
                    data: data,
                    amount: amount,
                    status: 'Pending Confirmation',
                    timestamp: new Date(),
                    notified: false 
                };

                window.pendingDonations.push(newDonation);
                window.donorDonations.push(newDonation);
                form.reset();
                window.selectDonationType('financial');
                window.showModal('success', 'Donation Logged (Mock)', `Your ${type} donation has been logged locally and is awaiting mock confirmation.`);
                
                window.renderPendingDonations(window.pendingDonations);
                window.renderMyDonations(window.donorDonations);
            };

            window.handleUpdateNeeds = (event, charityId) => {
                event.preventDefault();
                const needs = document.getElementById('needs-update').value;
                const charity = window.charityNeeds.find(c => c.id === charityId);
                if (charity) {
                    charity.needs = needs;
                    window.showModal('success', 'Update Successful (Mock)', `Needs for ${charityId} updated locally.`);
                    window.renderCharityNeeds(window.charityNeeds);
                }
            };
        };


        // --- Firestore Paths ---

        const charityNeedsPath = () => collection(db, `/artifacts/${APP_ID}/public/data/charity_needs`);
        const pendingDonationsPath = () => collection(db, `/artifacts/${APP_ID}/public/data/pending_donations`);
        const auditHistoryPath = () => collection(db, `/artifacts/${APP_ID}/public/data/audit_history`);
        const myDonationsPath = (userId) => collection(db, `/artifacts/${APP_ID}/users/${userId}/donations`);

        // --- Data Listeners ---

        const startRealTimeListeners = () => {
            // 1. Charity Needs Listener (Public Data)
            onSnapshot(charityNeedsPath(), (snapshot) => {
                window.charityNeeds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderCharityNeeds(window.charityNeeds);
                window.handleMatching();
            }, (error) => console.error("Error fetching charity needs:", error));

            // 2. Pending Donations Listener (Admin/Public Data)
            const qPending = query(pendingDonationsPath());
            onSnapshot(qPending, (snapshot) => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.pendingDonations = data;
                window.renderPendingDonations(data);
            }, (error) => console.error("Error fetching pending donations:", error));

            // 3. Audit History Listener (Admin/Public Data)
            const qAudit = query(auditHistoryPath());
            onSnapshot(qAudit, (snapshot) => {
                window.auditHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                window.renderAuditHistory(window.auditHistory);
            }, (error) => console.error("Error fetching audit history:", error));

            // 4. My Donations Listener (Private User Data)
            if (currentUserId) {
                const qMyDonations = query(myDonationsPath(currentUserId));
                onSnapshot(qMyDonations, (snapshot) => {
                    const newData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Check for new confirmed donations to notify the donor
                    if (window.donorDonations && newData) {
                        const newConfirmed = newData.filter(newD => 
                            newD.status === 'Confirmed' && 
                            !window.donorDonations.some(oldD => oldD.id === newD.id && oldD.status === 'Confirmed')
                        );
                        if (newConfirmed.length > 0) {
                            window.renderNotifications(newConfirmed);
                        }
                    }
                    
                    window.donorDonations = newData;
                    window.renderMyDonations(newData);
                }, (error) => console.error("Error fetching my donations:", error));
            }
        };

        // --- Data Submission ---

        window.handleDonationSubmit = async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const type = formData.get('donationType');
            const targetCharityId = document.querySelector('.charity-card.match-highlight')?.id || 'bd_relief';
            let data = {};
            let amount = 0;

            // This condition is handled by mock data handler if Firebase is bypassed
            if (!currentUserId && !FIREBASE_CONFIG.apiKey.includes('MOCK_API_KEY')) {
                window.showModal('error', 'Authentication Required', 'Please ensure you are signed in or authenticated anonymously to make a donation.');
                return;
            }

            if (type === 'financial') {
                amount = parseFloat(formData.get('amount'));
                if (isNaN(amount) || amount <= 0) {
                    window.showModal('error', 'Invalid Amount', 'Please enter a valid financial amount greater than zero.');
                    return;
                }
                data = { amount: amount };
            } else if (type === 'food' || type === 'goods') {
                const items = formData.get('items').trim();
                if (!items) {
                    window.showModal('error', 'Missing Details', `Please list the items you wish to donate under the ${type} category.`);
                    return;
                }
                data = { items: items };
            } else {
                window.showModal('error', 'Invalid Type', 'Unknown donation type selected.');
                return;
            }

            // MOCK SUBMISSION (handled above in setupMockData for bypassed mode)
            if (FIREBASE_CONFIG.apiKey.includes('MOCK_API_KEY')) {
                 // The mock submission logic is handled directly in setupMockData.handleDonationSubmit
                 return window.handleDonationSubmit(event); 
            }

            // REAL FIREBASE SUBMISSION
            try {
                const newDonation = {
                    donorId: currentUserId,
                    charityId: targetCharityId,
                    type: type,
                    data: data,
                    amount: amount, 
                    status: 'Pending Confirmation',
                    timestamp: serverTimestamp(),
                    notified: false 
                };

                const pendingRef = doc(pendingDonationsPath());
                await setDoc(pendingRef, newDonation);

                const myDonationRef = doc(myDonationsPath(currentUserId), pendingRef.id);
                await setDoc(myDonationRef, { ...newDonation, id: pendingRef.id });

                form.reset();
                window.selectDonationType('financial'); 
                window.showModal('success', 'Donation Logged!', `Your ${type} donation has been logged and is awaiting confirmation by the admin.`);
            } catch (error) {
                console.error("Error logging donation:", error);
                window.showModal('error', 'Submission Failed', 'Could not log donation due to a database error. Check console for details.');
            }
        };

        window.handleConfirmDonation = async (donationId, type, amount, charityId) => {
            // MOCK CONFIRMATION (handled above in setupMockData for bypassed mode)
            if (FIREBASE_CONFIG.apiKey.includes('MOCK_API_KEY')) {
                 // The mock confirmation logic is handled directly in setupMockData.handleConfirmDonation
                 return window.handleConfirmDonation(donationId, type, amount, charityId); 
            }

            // REAL FIREBASE CONFIRMATION
            try {
                const pendingRef = doc(pendingDonationsPath(), donationId);
                const charityRef = doc(charityNeedsPath(), charityId);
                const myDonationRef = doc(myDonationsPath(currentUserId), donationId);
                const auditRef = doc(auditHistoryPath());

                // 1. Get pending donation data
                const donationSnap = await getDoc(pendingRef);
                if (!donationSnap.exists()) throw new Error("Donation not found in pending queue.");
                const donationData = donationSnap.data();

                // 2. Update Charity Total Gained (Financial Only)
                if (type === 'financial') {
                    const charitySnap = await getDoc(charityRef);
                    if (charitySnap.exists()) {
                        const currentTotal = charitySnap.data().totalGained || 0;
                        await updateDoc(charityRef, {
                            totalGained: currentTotal + amount
                        });
                    }
                }
                
                // 3. Mark the donation as Confirmed in the original pending record (which is automatically deleted in a real app, but we update status here for tracking consistency)
                await setDoc(pendingRef, { ...donationData, status: 'Confirmed', notified: true, confirmationTimestamp: serverTimestamp() });
                
                // 4. Update status in Donor's private collection
                // NOTE: This is slightly redundant as the private collection should be updated by the listener, 
                // but we explicitly update the status to ensure the donor sees it immediately if they are signed in.
                // We use setDoc instead of updateDoc because the ID is known.
                await setDoc(myDonationRef, { ...donationData, status: 'Confirmed', notified: true, confirmationTimestamp: serverTimestamp() });


                // 5. Log to Audit History
                await setDoc(auditRef, { 
                    ...donationData, 
                    id: donationId, // Ensure ID is present in the audit log
                    status: 'Confirmed',
                    confirmationTimestamp: serverTimestamp() 
                });

                window.showModal('success', 'Confirmation Success', `Donation ID ${donationId} confirmed and logged to audit!`);

            } catch (error) {
                console.error("Error confirming donation:", error);
                window.showModal('error', 'Confirmation Failed', `Could not confirm donation. Error: ${error.message}`);
            }
        };

        window.handleUpdateNeeds = async (event, charityId) => {
            event.preventDefault();
            const needs = document.getElementById('needs-update').value;
            
            // MOCK UPDATE
            if (FIREBASE_CONFIG.apiKey.includes('MOCK_API_KEY')) {
                const charity = window.charityNeeds.find(c => c.id === charityId);
                if (charity) {
                    charity.needs = needs;
                    window.showModal('success', 'Update Successful (Mock)', `Needs for ${charityId} updated locally.`);
                    window.renderCharityNeeds(window.charityNeeds);
                }
                return;
            }

            // REAL FIREBASE UPDATE
            try {
                const charityRef = doc(charityNeedsPath(), charityId);
                await updateDoc(charityRef, { needs: needs, lastUpdated: serverTimestamp() });
                window.showModal('success', 'Update Successful', `Needs for ${charityId} published successfully.`);
            } catch (error) {
                console.error("Error updating needs:", error);
                window.showModal('error', 'Update Failed', 'Could not update charity needs.');
            }
        };

        // --- Rendering Functions ---

        /**
         * Renders the dynamic quote section.
         */
        const startQuoteRotator = () => {
            const quoteElement = document.getElementById('quote-section').querySelector('.quote-slide');
            let quoteIndex = Math.floor(Math.random() * motivationQuotes.length);

            const rotateQuote = () => {
                quoteElement.style.opacity = '0';
                setTimeout(() => {
                    quoteElement.textContent = motivationQuotes[quoteIndex];
                    quoteElement.style.opacity = '1';
                    quoteIndex = (quoteIndex + 1) % motivationQuotes.length;
                }, 500); // Wait for fade out
            };

            rotateQuote(); // Initial quote
            setInterval(rotateQuote, 8000); // Rotate every 8 seconds
        };


        /**
         * Renders the list of charity needs.
         */
        window.renderCharityNeeds = (needsArray) => {
            const container = document.getElementById('charity-needs-list');
            // Determine active type based on current visible tab
            const selectedType = document.querySelector('.donation-tab:not(.hidden) input[name="donationType"]')?.value || 'financial';
            
            if (!container) return;
            
            // Sort by totalGained descending (simulating JavaScript sorting since Firestore orderBy is avoided)
            const sortedNeeds = [...needsArray].sort((a, b) => (b.totalGained || 0) - (a.totalGained || 0));

            if (sortedNeeds.length === 0) {
                container.innerHTML = `<p class="text-gray-600 col-span-full">No active charity needs found.</p>`;
                return;
            }

            container.innerHTML = sortedNeeds.map(charity => {
                const needsList = charity.needs ? charity.needs.split(',').map(n => n.trim()) : [];
                const isMatch = needsList.some(need => 
                    (selectedType === 'financial' && need.toLowerCase().includes('$')) ||
                    (selectedType === 'food' && (need.toLowerCase().includes('rice') || need.toLowerCase().includes('food') || need.toLowerCase().includes('lentils') || need.toLowerCase().includes('produce'))) ||
                    (selectedType === 'goods' && (need.toLowerCase().includes('coats') || need.toLowerCase().includes('blankets') || need.toLowerCase().includes('supplies') || need.toLowerCase().includes('books') || need.toLowerCase().includes('toys')))
                );
                
                const matchClass = isMatch ? 'match-highlight border-teal-500' : 'border-gray-200';
                const matchIcon = isMatch ? '<i class="fas fa-check-circle text-teal-500 mr-2"></i> Matching Need!' : '';
                
                const needsHtml = needsList.slice(0, 3).map(n => `<span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-0.5 rounded-full">${n}</span>`).join(' ');

                return `
                    <div id="${charity.id}" class="charity-card bg-white p-6 rounded-xl shadow-md border-b-4 ${matchClass}">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-xl font-bold text-gray-800">${charity.name}</h3>
                            <div class="text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">${charity.region}</div>
                        </div>
                        <p class="text-sm text-gray-600 mb-3">ID: ${charity.id}</p>
                        <p class="text-sm font-semibold text-gray-700 mb-2">Total Gained: <span class="text-green-600 font-extrabold">${(charity.totalGained || 0).toLocaleString()} BDT</span></p>
                        
                        <p class="text-xs font-medium text-gray-700 mb-3">${matchIcon} Top Needs:</p>
                        <div class="space-x-1 space-y-1">${needsHtml}</div>
                    </div>
                `;
            }).join('');
        };


        /**
         * Renders the user's donation history.
         */
        window.renderMyDonations = (donations) => {
            const tbody = document.getElementById('my-donations-table');
            if (!tbody) return;

            // Sort by timestamp descending
            const sortedDonations = [...donations].sort((a, b) => (b.timestamp?.toDate ? b.timestamp.toDate().getTime() : b.timestamp?.getTime() || 0) - (a.timestamp?.toDate ? a.timestamp.toDate().getTime() : a.timestamp?.getTime() || 0));

            if (sortedDonations.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No donations tracked yet.</td></tr>`;
                return;
            }

            tbody.innerHTML = sortedDonations.map(d => {
                const date = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleDateString() : (d.timestamp?.toLocaleDateString() || 'N/A');
                const statusClass = d.status === 'Confirmed' ? 'text-green-600 font-bold' : 'text-yellow-600';
                const details = d.type === 'financial' ? `${d.amount.toLocaleString()} BDT` : (d.data?.items || 'N/A');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.type.charAt(0).toUpperCase() + d.type.slice(1)}</td>
                        <td class="px-4 py-4 whitespace-pre-wrap text-sm text-gray-700 max-w-xs">${details}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm ${statusClass}">${d.status}</td>
                    </tr>
                `;
            }).join('');
        };

        /**
         * Renders the admin pending donations table.
         */
        window.renderPendingDonations = (donations) => {
            const tbody = document.getElementById('pending-donations-table');
            if (!tbody) return;

            const pending = donations.filter(d => d.status === 'Pending Confirmation');
            
            // Sort by timestamp descending
            pending.sort((a, b) => (b.timestamp?.toDate ? b.timestamp.toDate().getTime() : b.timestamp?.getTime() || 0) - (a.timestamp?.toDate ? a.timestamp.toDate().getTime() : a.timestamp?.getTime() || 0));
            
            if (pending.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No pending donations to review.</td></tr>`;
                return;
            }

            tbody.innerHTML = pending.map(d => {
                const date = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleDateString() : (d.timestamp?.toLocaleDateString() || 'N/A');
                const details = d.type === 'financial' ? `${d.amount.toLocaleString()} BDT` : (d.data?.items || 'N/A');
                // Ensure amount is safe for inline function call
                const amount = d.amount || 0;

                return `
                    <tr class="hover:bg-yellow-50">
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.type.charAt(0).toUpperCase() + d.type.slice(1)}</td>
                        <td class="px-4 py-4 whitespace-pre-wrap text-sm text-gray-700 max-w-xs">${details}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${d.charityId}</td>
                        <td class="px-4 py-4 whitespace-nowrap">
                            <button class="dynamic-btn bg-green-500 text-white text-xs px-3 py-1 rounded-lg hover:bg-green-600" 
                                onclick="window.handleConfirmDonation('${d.id}', '${d.type}', ${amount}, '${d.charityId}')">
                                Confirm & Log
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        /**
         * Renders the admin audit history table.
         */
        window.renderAuditHistory = (history) => {
            const tbody = document.getElementById('audit-history-table');
            if (!tbody) return;
            
            if (!history || history.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 text-center">No history recorded yet.</td></tr>`;
                return;
            }

            // Sort by confirmationTimestamp descending
            history.sort((a, b) => (b.confirmationTimestamp?.toDate ? b.confirmationTimestamp.toDate().getTime() : b.confirmationTimestamp?.getTime() || 0) - (a.confirmationTimestamp?.toDate ? a.confirmationTimestamp.toDate().getTime() : a.confirmationTimestamp?.getTime() || 0));

            tbody.innerHTML = history.map(d => {
                const date = d.confirmationTimestamp?.toDate ? d.confirmationTimestamp.toDate().toLocaleDateString() : (d.confirmationTimestamp?.toLocaleDateString() || 'N/A');
                const details = d.type === 'financial' ? `${d.amount.toLocaleString()} BDT` : (d.data?.items || 'N/A');

                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${d.type.charAt(0).toUpperCase() + d.type.slice(1)}</td>
                        <td class="px-4 py-4 whitespace-pre-wrap text-sm text-gray-700 max-w-xs">${details}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-600">${d.charityId}</td>
                    </tr>
                `;
            }).join('');
        };


        /**
         * Renders the donor notifications.
         */
        window.renderNotifications = (newlyConfirmed) => {
            const countSpan = document.getElementById('notification-count');
            const list = document.getElementById('notification-list');

            window.lastNotificationCount += newlyConfirmed.length;
            
            if (window.lastNotificationCount > 0) {
                countSpan.textContent = window.lastNotificationCount;
                countSpan.classList.remove('opacity-0');
            }

            const newHtml = newlyConfirmed.map(d => {
                const date = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleDateString() : (d.timestamp?.toLocaleDateString() || 'N/A');
                const details = d.type === 'financial' ? `${d.amount.toLocaleString()} BDT` : `${d.type.charAt(0).toUpperCase() + d.type.slice(1)} items`;
                return `
                    <div class="p-3 hover:bg-green-50 flex justify-between items-center text-sm">
                        <div>
                            <p class="font-semibold text-green-700">✅ Your ${d.type} donation to ${d.charityId} was confirmed!</p>
                            <p class="text-xs text-gray-500">${details} on ${date}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Prepend new notifications
            const noMessage = list.querySelector('.text-center.italic');
            if(noMessage) noMessage.remove();
            list.insertAdjacentHTML('afterbegin', newHtml);
        };

        // --- UI Logic and Toggles ---

        /**
         * Updates the UI based on the current user role.
         */
        window.updateRoleView = (role) => {
            const banner = document.getElementById('role-banner');
            const toggleBtn = document.getElementById('role-toggle-btn');
            const donorView = document.getElementById('donor-view');
            const loginView = document.getElementById('login-view');
            const adminView = document.getElementById('admin-view');
            const charityPortalView = document.getElementById('charity-portal-view');
            const notificationBtn = document.getElementById('notification-button');

            // Hide all
            donorView.classList.add('hidden');
            loginView.classList.add('hidden');
            adminView.classList.add('hidden');
            charityPortalView.classList.add('hidden');
            notificationBtn.classList.add('hidden');

            switch (role) {
                case 'donor':
                    banner.className = 'mb-6 p-4 rounded-lg text-center font-bold text-lg shadow-md bg-blue-100 text-blue-800 transition-colors';
                    banner.textContent = 'Welcome, Donor! View Needs and Contribute.';
                    toggleBtn.textContent = 'Switch to Staff/Admin Login';
                    donorView.classList.remove('hidden');
                    notificationBtn.classList.remove('hidden');
                    break;
                case 'login':
                    banner.className = 'mb-6 p-4 rounded-lg text-center font-bold text-lg shadow-md bg-gray-100 text-gray-800 transition-colors';
                    banner.textContent = 'Staff/Charity Login Interface';
                    toggleBtn.textContent = 'Switch to Donor View';
                    loginView.classList.remove('hidden');
                    break;
                case 'admin':
                    banner.className = 'mb-6 p-4 rounded-lg text-center font-bold text-lg shadow-md bg-red-100 text-red-800 transition-colors';
                    banner.textContent = 'ADMINISTRATOR PORTAL - Full Audit Access';
                    toggleBtn.textContent = 'Sign Out';
                    adminView.classList.remove('hidden');
                    break;
                case 'charity':
                    const charityId = document.getElementById('login-id')?.value?.toLowerCase() || 'bd_relief'; // Fallback
                    const charityInfo = window.charityNeeds.find(c => c.id === charityId);
                    if (charityInfo) {
                         document.getElementById('charity-info').innerHTML = `<p class="text-xl font-bold">${charityInfo.name}</p><p class="text-sm text-gray-500">ID: ${charityId}</p>`;
                         document.getElementById('needs-update').value = charityInfo.needs || '';
                         document.getElementById('update-needs-form').onsubmit = (e) => window.handleUpdateNeeds(e, charityId);
                    }
                    banner.className = 'mb-6 p-4 rounded-lg text-center font-bold text-lg shadow-md bg-teal-100 text-teal-800 transition-colors';
                    banner.textContent = `CHARITY PARTNER PORTAL (${charityId.toUpperCase()})`;
                    toggleBtn.textContent = 'Sign Out';
                    charityPortalView.classList.remove('hidden');
                    break;
            }
            userRole = role === 'login' ? userRole : role;
            document.getElementById('notification-panel').classList.add('hidden'); // Hide panel on role switch
            window.handleMatching(); // Re-run matching in case of role change
        };

        window.toggleRole = async () => {
            if (userRole === 'donor') {
                updateRoleView('login');
            } else {
                if (auth && auth.currentUser) {
                    await auth.signOut();
                }
                // Reset everything to donor view
                window.lastNotificationCount = 0;
                document.getElementById('notification-count').classList.add('opacity-0');
                updateRoleView('donor');
            }
        };

        window.selectDonationType = (type) => {
            const tabs = document.querySelectorAll('.donation-tab');
            const buttons = document.querySelectorAll('.tab-button');
            const formInputs = document.querySelectorAll('.donation-tab textarea, .donation-tab input[type="number"]');

            // 1. Hide all tabs and disable all inputs
            tabs.forEach(tab => tab.classList.add('hidden'));
            formInputs.forEach(input => input.setAttribute('disabled', 'true'));

            // 2. Reset button styles
            buttons.forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600', 'bg-blue-50', 'font-bold');
                btn.classList.add('text-gray-600', 'hover:text-blue-600', 'hover:bg-gray-50');
            });

            // 3. Show selected tab and enable its inputs
            const selectedTab = document.getElementById(`${type}-tab`);
            const selectedButton = document.querySelector(`.tab-button[data-type="${type}"]`);

            if (selectedTab && selectedButton) {
                selectedTab.classList.remove('hidden');
                selectedTab.querySelectorAll('textarea, input[type="number"]').forEach(input => input.removeAttribute('disabled'));
                
                selectedButton.classList.add('text-blue-600', 'border-blue-600', 'bg-blue-50', 'font-bold');
                selectedButton.classList.remove('text-gray-600', 'hover:text-blue-600', 'hover:bg-gray-50');
            }

            // 4. Rerun matching logic
            window.handleMatching(type);
        };

        window.handleMatching = (selectedType = null) => {
            // Guard clause to prevent errors if data hasn't loaded yet
            if (!window.charityNeeds || window.charityNeeds.length === 0) return;

            const activeType = selectedType || document.querySelector('.donation-tab:not(.hidden) input[name="donationType"]')?.value || 'financial';
            // Re-render charity list to ensure matching is based on the selected type
            window.renderCharityNeeds(window.charityNeeds); 
        };
        
        // --- Modal Logic ---

        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalHeader = document.getElementById('modal-header');
        const modalCloseBtn = document.getElementById('modal-close-button');

        window.showModal = (type, title, message) => {
            modalTitle.innerHTML = ''; // Clear previous content

            if (type === 'success') {
                modalHeader.className = 'p-4 flex items-center justify-between text-white bg-green-500';
                modalTitle.innerHTML = `<i class="fas fa-check-circle text-2xl mr-2"></i> ${title}`;
                modalCloseBtn.className = 'dynamic-btn mt-6 w-full py-2 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition-colors';
            } else if (type === 'error') {
                modalHeader.className = 'p-4 flex items-center justify-between text-white bg-red-500';
                modalTitle.innerHTML = `<i class="fas fa-exclamation-triangle text-2xl mr-2"></i> ${title}`;
                modalCloseBtn.className = 'dynamic-btn mt-6 w-full py-2 rounded-lg text-white font-semibold bg-red-600 hover:bg-red-700 transition-colors';
            } else {
                modalHeader.className = 'p-4 flex items-center justify-between text-white bg-blue-500';
                modalTitle.innerHTML = `<i class="fas fa-info-circle text-2xl mr-2"></i> ${title}`;
                modalCloseBtn.className = 'dynamic-btn mt-6 w-full py-2 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition-colors';
            }
            
            modalMessage.textContent = message;
            modalCloseBtn.textContent = 'Close';
            modalBackdrop.classList.remove('hidden');
        };

        window.hideModal = () => {
            modalBackdrop.classList.add('hidden');
        };

        // --- Auth Implementation ---

        document.getElementById('login-form').addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = document.getElementById('login-id').value.toLowerCase();
            const password = document.getElementById('login-password').value;

            if (id === 'admin' && password === 'uniadmin') {
                window.showModal('success', 'Admin Login Success', 'Welcome to the Administrator Portal.');
                window.updateRoleView('admin');
                return;
            }

            const charity = MOCK_CHARITIES.find(c => c.id === id);
            if (charity && charity.password === password) {
                window.showModal('success', 'Charity Login Success', `Welcome, ${charity.name} Partner!`);
                window.updateRoleView('charity');
                return;
            }

            window.showModal('error', 'Login Failed', 'Invalid User ID or Password.');
        });

        window.toggleNotifications = () => {
            const panel = document.getElementById('notification-panel');
            panel.classList.toggle('hidden');
            if (panel.classList.contains('hidden')) {
                window.lastNotificationCount = 0; // Reset count when panel is closed
                document.getElementById('notification-count').classList.add('opacity-0');
            }
        };


        // --- Application Setup ---

        const setupApp = () => {
            window.selectDonationType('financial');
            startQuoteRotator();
            initializeFirebase(); 
        };

        document.addEventListener('DOMContentLoaded', setupApp);

    </script>
</body>
</html>
